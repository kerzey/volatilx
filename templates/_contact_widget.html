<style>
    .contact-widget {
        position: fixed;
        right: 32px;
        bottom: 32px;
        z-index: 1200;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
    }

    .contact-fab {
        border: 2px solid rgba(255, 255, 255, 0.72);
        border-radius: 999px;
        background: linear-gradient(135deg, #0ea5e9, #0369a1);
        color: #ffffff;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.7rem 1.1rem;
        box-shadow: 0 14px 28px rgba(14, 165, 233, 0.32);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        letter-spacing: 0.02em;
    }

    .contact-fab:hover,
    .contact-fab:focus {
        transform: translateY(-2px);
        box-shadow: 0 22px 44px rgba(14, 165, 233, 0.38);
        outline: none;
    }

    .contact-fab:active {
        transform: translateY(0);
        filter: brightness(0.97);
    }

    .contact-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
    }

    .contact-modal.is-visible {
        opacity: 1;
        pointer-events: auto;
    }

    .contact-modal__dialog {
        position: relative;
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 28px 60px rgba(15, 23, 42, 0.28);
        padding: 2rem 2.2rem;
        width: min(420px, calc(100% - 2.5rem));
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .contact-modal__close {
        position: absolute;
        right: 18px;
        top: 16px;
        border: none;
        background: transparent;
        font-size: 1.8rem;
        line-height: 1;
        color: rgba(15, 23, 42, 0.55);
        cursor: pointer;
        padding: 0;
    }

    .contact-form__field label {
        font-size: 1.2rem;
        font-weight: 600;
        color: rgba(30, 27, 75, 0.9);
    }

    .contact-form__field input,
    .contact-form__field textarea {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        padding: 1.1rem 1.3rem;
        font-size: 1.1rem;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.94);
        color: #1f2937;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .contact-form__submit {
        border: none;
        border-radius: 999px;
        background: linear-gradient(135deg, #10b981, #047857);
        color: #ffffff;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 1rem 2.4rem;
        cursor: pointer;
        box-shadow: 0 24px 48px rgba(5, 150, 105, 0.28);
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    .contact-form__submit:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 30px 58px rgba(4, 120, 87, 0.34);
    }

    .contact-form__status {
        font-size: 1rem;
        color: rgba(55, 65, 81, 0.82);
        min-height: 1.5rem;
    }
</style>
<div class="contact-widget" id="contactWidget">
    <button type="button" class="contact-fab" id="contactFab" aria-label="Contact VolatilX support">
        Contact
    </button>
    <div class="contact-modal" id="contactModal" aria-hidden="true" style="display: none;">
        <div class="contact-modal__backdrop" id="contactBackdrop"></div>
        <div class="contact-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="contactModalTitle">
            <button type="button" class="contact-modal__close" id="contactClose" aria-label="Close contact form">&times;</button>
            <h2 class="contact-modal__title" id="contactModalTitle">Contact Us</h2>
            <p class="contact-modal__intro">Have a question or feedback? Send us a quick note and we will respond shortly.</p>
            <form class="contact-form" id="contactForm">
                <div class="contact-form__field">
                    <label for="contactName">Name</label>
                    <input type="text" id="contactName" name="name" maxlength="120" required>
                </div>
                <div class="contact-form__field">
                    <label for="contactEmail">Email</label>
                    <input type="email" id="contactEmail" name="email" maxlength="255" value="{{ user.email if user is defined and user.email is not none else '' }}" required>
                </div>
                <div class="contact-form__field">
                    <label for="contactMessage">Message</label>
                    <textarea id="contactMessage" name="message" rows="5" maxlength="4000" placeholder="How can we help?" required></textarea>
                </div>
                <div class="contact-form__actions">
                    <span class="contact-form__status" id="contactStatus" role="status" aria-live="polite"></span>
                    <button type="submit" class="contact-form__submit" id="contactSubmit">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
(function() {
    const widget = document.getElementById('contactWidget');
    if (!widget) {
        return;
    }
    const fab = document.getElementById('contactFab');
    const modal = document.getElementById('contactModal');
    const backdrop = document.getElementById('contactBackdrop');
    const closeBtn = document.getElementById('contactClose');
    const form = document.getElementById('contactForm');
    const submitBtn = document.getElementById('contactSubmit');
    const statusEl = document.getElementById('contactStatus');
    const nameInput = document.getElementById('contactName');
    const emailInput = document.getElementById('contactEmail');
    const messageInput = document.getElementById('contactMessage');

    const openModal = () => {
        modal.classList.add('is-visible');
        modal.setAttribute('aria-hidden', 'false');
        modal.style.display = 'flex';
        statusEl.textContent = '';
        setTimeout(() => {
            if (nameInput && !nameInput.value) {
                nameInput.focus();
            } else if (messageInput) {
                messageInput.focus();
            }
        }, 50);
        document.body.classList.add('contact-modal--open');
    };

    const closeModal = () => {
        modal.classList.remove('is-visible');
        modal.setAttribute('aria-hidden', 'true');
        modal.style.display = 'none';
        document.body.classList.remove('contact-modal--open');
        fab.focus();
    };

    const handleKeyDown = (event) => {
        if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
            closeModal();
        }
    };

    const showStatus = (message, variant) => {
        if (!statusEl) {
            return;
        }
        statusEl.textContent = message || '';
        statusEl.className = 'contact-form__status';
        if (variant) {
            statusEl.classList.add(`contact-form__status--${variant}`);
        }
    };

    const handleSubmit = async (event) => {
        event.preventDefault();
        if (!form || !submitBtn) {
            return;
        }
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const message = messageInput.value.trim();

        if (!name || !email || !message) {
            showStatus('Please complete all fields.', 'error');
            return;
        }

        submitBtn.disabled = true;
        showStatus('Sending messageâ€¦', 'info');

        try {
            const response = await fetch('/api/contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, message })
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok || !data.success) {
                const errorMessage = (data && data.error) || 'We could not send your message. Please try again.';
                showStatus(errorMessage, 'error');
                return;
            }

            showStatus('Message sent! We will reach out soon.', 'success');
            form.reset();
            setTimeout(() => {
                closeModal();
            }, 1200);
        } catch (error) {
            console.error('Contact form error', error);
            showStatus('Unexpected error. Please try again later.', 'error');
        } finally {
            submitBtn.disabled = false;
        }
    };

    if (modal) {
        modal.style.display = 'none';
    }

    if (fab) {
        fab.addEventListener('click', openModal);
    }
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    if (backdrop) {
        backdrop.addEventListener('click', closeModal);
    }
    if (form) {
        form.addEventListener('submit', handleSubmit);
    }
    document.addEventListener('keydown', handleKeyDown);
})();
</script>

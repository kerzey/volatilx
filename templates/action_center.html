<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolatilX - Action Center</title>
    {% if principal_plan_json or principal_plan_map_json %}
    <link rel="stylesheet" href="/static/css/action-center2.css">
    {% endif %}
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/css/volatilx-header.css">
</head>
<body class="action-center-page{% if principal_plan_json or principal_plan_map_json %} action-center-page--react{% endif %}" data-live-price="{{ 'true' if live_price_enabled else 'false' }}" data-timeframe="{{ timeframe }}" data-intent="{{ intent }}">
    {% from "_header.html" import render_header %}
    {% set dashboards_count = dashboards|length if dashboards else 0 %}
    {% set header_timeframe = timeframe %}
    {% set header_intent = intent %}
    {% set primary_symbol = None %}
    {% if primary_dashboard %}
        {% set primary_payload = primary_dashboard.action_data %}
        {% set primary_symbol = primary_payload.symbol if primary_payload and primary_payload.symbol else (primary_dashboard.symbol_display if primary_dashboard and primary_dashboard.symbol_display else primary_dashboard.symbol) %}
        {% if primary_dashboard.timeframe %}
            {% set header_timeframe = primary_dashboard.timeframe %}
        {% endif %}
        {% if primary_dashboard.intent %}
            {% set header_intent = primary_dashboard.intent %}
        {% endif %}
    {% endif %}
    {% set header_timeframe_label = header_timeframe|title if header_timeframe else 'Not set' %}
    {% set header_intent_label = header_intent|title if header_intent else 'Not set' %}
    {% set header_user_email = user.email if user else None %}
    {{ render_header(
        page='action-center',
        title='Action Center',
        subtitle='Your AI-powered trading cockpit &mdash; real-time signals, levels, and actions.',
        badge='Market Command',
        user_email=header_user_email
    ) }}

    <main class="action-center">
        <div id="action-center2-root" data-react-root>
            {% if not principal_plan_json and not principal_plan_map_json %}
            <div class="action-center__empty">
                <p>We could not find an active principal plan. Run a fresh AI analysis to populate the Action Center.</p>
            </div>
            {% endif %}
        </div>
    </main>

    {% if principal_plan_json %}
    <script id="actionCenterPrincipalPlan" type="application/json">{{ principal_plan_json | safe }}</script>
    {% endif %}
    {% if principal_plan_map_json %}
    <script id="actionCenterPrincipalPlanMap" type="application/json">{{ principal_plan_map_json | safe }}</script>
    {% endif %}
    {% if principal_plan_order_json %}
    <script id="actionCenterPrincipalPlanOrder" type="application/json">{{ principal_plan_order_json | safe }}</script>
    {% endif %}
    {% if principal_plan_json or principal_plan_map_json %}
    <script>
    (function () {
        var planPayload = null;
        var planSource = document.getElementById('actionCenterPrincipalPlan');
        if (planSource) {
            try {
                planPayload = JSON.parse(planSource.textContent || '{}');
            } catch (error) {
                console.warn('Failed to parse Action Center principal plan payload', error);
                planPayload = null;
            }
        }

        var planMap = {};
        var mapSource = document.getElementById('actionCenterPrincipalPlanMap');
        if (mapSource) {
            try {
                planMap = JSON.parse(mapSource.textContent || '{}');
            } catch (error) {
                console.warn('Failed to parse Action Center plan map payload', error);
                planMap = {};
            }
        }

        var planOrder = [];
        var orderSource = document.getElementById('actionCenterPrincipalPlanOrder');
        if (orderSource) {
            try {
                planOrder = JSON.parse(orderSource.textContent || '[]');
            } catch (error) {
                console.warn('Failed to parse Action Center plan order payload', error);
                planOrder = [];
            }
        }

        var planOptions = [];
        var seenSymbols = new Set();

        function pushOption(symbol, plan) {
            if (!symbol || !plan || seenSymbols.has(symbol)) {
                return;
            }
            seenSymbols.add(symbol);
            planOptions.push({
                symbol: symbol,
                symbolDisplay: plan.symbol_display || symbol,
                isFavorite: Boolean(plan.is_favorited),
                plan: plan,
            });
        }

        if (Array.isArray(planOrder) && planOrder.length) {
            planOrder.forEach(function (symbol) {
                var plan = planMap && Object.prototype.hasOwnProperty.call(planMap, symbol)
                    ? planMap[symbol]
                    : undefined;
                if (plan) {
                    pushOption(symbol, plan);
                }
            });
        }

        if (planMap && typeof planMap === 'object') {
            Object.keys(planMap).forEach(function (key) {
                if (planMap[key]) {
                    pushOption(key, planMap[key]);
                }
            });
        }

        if (planPayload && planPayload.symbol && !seenSymbols.has(planPayload.symbol)) {
            pushOption(planPayload.symbol, planPayload);
        }

        if (!planPayload && planOptions.length) {
            planPayload = planOptions[0].plan;
        }

        if (planPayload) {
            window.__ACTION_CENTER_PRINCIPAL_PLAN__ = planPayload;
        }

        window.__ACTION_CENTER_PRINCIPAL_PLAN_OPTIONS__ = planOptions;
    }());
    </script>
    {% endif %}
    <script type="module" src="/static/js/action-center2.js"></script>
</body>
</html>

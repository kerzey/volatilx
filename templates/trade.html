<! DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolatilX - Trading Dashboard</title>
    <!-- Link to your main CSS -->
    <link rel="stylesheet" href="/static/style.css">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BC00YPJSRJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BC00YPJSRJ');
    </script>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="/static/VolatilX_Logo.PNG" alt="VolatilX Logo">
            <span>VolatilX</span>
        </div>
        <div class="nav-links">
            <a href="/trade">Trading</a>
            <a href="/settings">Settings</a>
            <span>{{ user.email }}</span>
            <a href="/logout">Logout</a>
        </div>
    </div>
    
    <div class="container">
        <div class="trading-panel">
            <h2 class="panel-title">AI Trading Analysis</h2>
            <form id="tradingForm">
                <div class="input-group">
                    <label for="stockSymbol">Stock Symbol</label>
                    <input type="text" id="stockSymbol" name="stock_symbol" placeholder="Enter stock symbol (e.g., AAPL, TSLA, MSFT)" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="useAiAnalysis" name="use_ai_analysis" value="true">
                    <label for="useAiAnalysis">Get AI Investment Strategy</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="usePrincipalAgent" name="use_principal_agent" value="true" checked>
                    <label for="usePrincipalAgent">Generate Principal Trading Plan</label>
                </div>
                <div class="checkbox-group sub-option">
                    <input type="checkbox" id="includePrincipalRaw" name="include_principal_raw_results" value="true" disabled>
                    <label for="includePrincipalRaw">Include expert-level details in plan response</label>
                </div>
                <button type="submit" class="analyze-btn" id="analyzeBtn">
                    Analyze Stock
                </button>
            </form>
        </div>
        
        <div class="results-panel" id="resultsPanel">
            <h2 class="panel-title">Analysis Results</h2>
            
            <div class="tabs hidden" id="resultTabs">
                <div class="tab active" onclick="showTab('technical', event)" id="technicalTab">Technical Analysis</div>
                <div class="tab" onclick="showTab('ai', event)" id="aiTab" style="display:none;">AI Investment Strategy</div>
                <div class="tab" onclick="showTab('principal', event)" id="principalTab" style="display:none;">Principal Plan</div>
            </div>
            
            <div id="resultsContent">
                <div id="technicalContent" class="tab-content active"></div>
                <div id="aiContent" class="tab-content"></div>
                <div id="principalContent" class="tab-content"></div>
            </div>
        </div>
    </div>
    
    <script>
        let currentResults = null;
        const usePrincipalAgentInput = document.getElementById('usePrincipalAgent');
        const includePrincipalRawInput = document.getElementById('includePrincipalRaw');

        includePrincipalRawInput.disabled = !usePrincipalAgentInput.checked;

        usePrincipalAgentInput.addEventListener('change', (event) => {
            const enabled = event.target.checked;
            includePrincipalRawInput.disabled = !enabled;
            if (!enabled) {
                includePrincipalRawInput.checked = false;
            }
        });
        
        document.getElementById('tradingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const stockSymbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            const useAiAnalysis = document.getElementById('useAiAnalysis').checked;
            const usePrincipalAgent = usePrincipalAgentInput.checked;
            const includePrincipalRaw = includePrincipalRawInput.checked;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');
            const resultTabs = document.getElementById('resultTabs');
            const aiTab = document.getElementById('aiTab');
            const principalTab = document.getElementById('principalTab');
            const technicalTab = document.getElementById('technicalTab');
            
            if (!stockSymbol) {
                alert('Please enter a stock symbol');
                return;
            }
            
            // Show loading state
            analyzeBtn.disabled = true;
            const activeTasks = [];
            if (useAiAnalysis) activeTasks.push('AI');
            if (usePrincipalAgent) activeTasks.push('Principal');
            analyzeBtn.textContent = activeTasks.length
                ? `Analyzing (${activeTasks.join(' + ')})...`
                : 'Analyzing...';
            resultsPanel.style.display = 'block';
            resultTabs.classList.add('hidden');
            aiTab.style.display = 'none';
            principalTab.style.display = 'none';
            aiTab.classList.remove('active');
            principalTab.classList.remove('active');
            technicalTab.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('technicalContent').classList.add('active');
            
            document.getElementById('technicalContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing ${stockSymbol}... This may take a few moments.</p>
                </div>
            `;
            document.getElementById('aiContent').innerHTML = '';
            document.getElementById('principalContent').innerHTML = '';
            
            try {
                const response = await fetch('/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stock_symbol: stockSymbol,
                        use_ai_analysis: useAiAnalysis,
                        use_principal_agent: usePrincipalAgent,
                        include_principal_raw_results: includePrincipalRaw
                    })
                });
                const data = await response.json();
                if (data.success) {
                    currentResults = data;
                    displayResults(data, stockSymbol);
                    let extraTabs = 0;
                    if (useAiAnalysis) {
                        displayAiAnalysis(data.ai_analysis);
                        aiTab.style.display = 'block';
                        extraTabs += 1;
                    }
                    if (usePrincipalAgent) {
                        displayPrincipalPlan(data.principal_plan);
                        principalTab.style.display = 'block';
                        extraTabs += 1;
                    }
                    if (extraTabs > 0) {
                        resultTabs.classList.remove('hidden');
                    }
                } else {
                    displayError(data.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Error:', error);
                displayError('Network error occurred. Please try again.');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Stock';
            }
        });

        // Code Generated by Sidekick is for learning and experimentation purposes only.
        function safeToFixed(val, digits=2, fallback='N/A') {
        return (val !== null && val !== undefined) ? Number(val).toFixed(digits) : fallback;
        }
        function displayResults(data, symbol) {
            const technicalContent = document.getElementById('technicalContent');
            const result = data.result;
            const symbolData = result && result[symbol] ? result[symbol] : null;
            if (!symbolData) {
                technicalContent.innerHTML = `
                    <div class="result-item error">
                        <div class="result-title">Result Not Found</div>
                        <div class="result-content">No analysis data for ${symbol}.</div>
                    </div>
                `;
                return;
            }
            // Consensus summary table (no inline style)
            const cons = symbolData.consensus;
            let consensusHtml = `<table>
                <tr>
                    <th colspan="2">Consensus Summary</th>
                </tr>
                <tr>
                    <td>Overall Recommendation</td>
                    <td><strong>${cons.overall_recommendation}</strong></td>
                </tr>
                <tr>
                    <td>Confidence</td>
                    <td>${cons.confidence}</td>
                </tr>
                <tr>
                    <td>Strength</td>
                    <td>${cons.strength.toFixed(2)}%</td>
                </tr>
                <tr>
                    <td>Buy Signals</td>
                    <td>${cons.buy_signals}</td>
                </tr>
                <tr>
                    <td>Sell Signals</td>
                    <td>${cons.sell_signals}</td>
                </tr>
                <tr>
                    <td>Hold Signals</td>
                    <td>${cons.hold_signals}</td>
                </tr>
                <tr>
                    <td>Reasoning</td>
                    <td>
                    <ul>
                    ${cons.reasoning.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                    </td>
                </tr>
            </table>`;
            // Decisions by timeframe (no inline style)
            const decisions = symbolData.decisions;
            let decisionHtml = `<table class="decisions-table">
                <thead>
                <tr>
                    <th>Timeframe</th>
                    <th>Sig.</th>
                    <th>Conf.</th>
                    <th>Strength</th>
                    <th>Entry</th>
                    <th>Stop</th>
                    <th>Target</th>
                    <th>R/R</th>
                    <th>Reasoning</th>
                </tr>
                </thead>
                <tbody>
            `;
            for (const [tf, d] of Object.entries(decisions)) {
                decisionHtml += `
                <tr>
                    <td data-label="Timeframe">${tf}</td>
                    <td data-label="Sig." style="color:${d.recommendation === 'BUY' ? '#27ae60' : d.recommendation === 'SELL' ? '#e74c3c' : '#333'};font-weight:bold">${d.recommendation}</td>
                    <td data-label="Conf.">${d.confidence}</td>
                    <td data-label="Strength">${safeToFixed(d.strength)}%</td>
                    <td data-label="Entry">$${safeToFixed(d.entry_price)}</td>
                    <td data-label="Stop">$${safeToFixed(d.stop_loss)}</td>
                    <td data-label="Target">$${safeToFixed(d.take_profit)}</td>
                    <td data-label="R/R">${safeToFixed(d.risk_reward_ratio)}</td>
                    <td data-label="Reasoning">
                    <ul>
                    ${d.reasoning.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                    </td>
                </tr>
                `;
            }
            decisionHtml += "</tbody></table>";
            technicalContent.innerHTML = `
                <div class="result-item success">
                    <div class="result-title">Technical Analysis Table for ${symbol}</div>
                    <div class="result-content">
                        ${consensusHtml}
                        ${decisionHtml}
                    </div>
                </div>
            `;
        }
        function displayAiAnalysis(aiAnalysis) {
            const aiContent = document.getElementById('aiContent');
            if (!aiAnalysis) {
                aiContent.innerHTML = `<div class="result-item">
                    <div class="result-title">AI Analysis</div>
                    <div class="result-content">AI analysis was not requested or failed.</div>
                </div>`;
                return;
            }
            if (!aiAnalysis.success) {
                aiContent.innerHTML = `<div class="result-item error">
                    <div class="result-title">AI Analysis Failed</div>
                    <div class="result-content">${aiAnalysis.error}</div>
                </div>`;
                return;
            }
            const analysis = aiAnalysis.analysis;
            let html = `<div class="result-item success ai-analysis">
                <div class="result-title">AI Investment strategy</div>
                <div class="result-content">AI analysis completed successfully using ${aiAnalysis.tokens_used || 'N/A'} tokens.</div>
            </div>`;
            if (analysis) {
                if (analysis.market_position) {
                    html += `<div class="ai-section">
                        <div class="ai-section-title">Current Market Position</div>
                        <div class="result-content">${analysis.market_position}</div>
                    </div>`;
                }
                if (analysis.short_term_strategy) {
                    html += `<div class="ai-section">
                        <div class="ai-section-title">Short-Term Strategy (1-30 days)</div>
                        <div class="result-content">${analysis.short_term_strategy}</div>
                    </div>`;
                }
                if (analysis.long_term_strategy) {
                    html += `<div class="ai-section">
                        <div class="ai-section-title">Long-Term Strategy (3-12 months)</div>
                        <div class="result-content">${analysis.long_term_strategy}</div>
                    </div>`;
                }
                if (analysis.risk_assessment) {
                    html += `<div class="ai-section">
                        <div class="ai-section-title">Risk Assessment</div>
                        <div class="result-content">${analysis.risk_assessment}</div>
                    </div>`;
                }
                if (analysis.action_items) {
                    html += `<div class="ai-section">
                        <div class="ai-section-title">Action Items</div>
                        <div class="result-content">${analysis.action_items}</div>
                    </div>`;
                }
                if (analysis.summary) {
                    html += `<div class="ai-section">
                        <div class="ai-section-title">Summary</div>
                        <div class="result-content">${analysis.summary}</div>
                    </div>`;
                }
            }
            if (!analysis && aiAnalysis.raw_response) {
                html += `<div class="result-item ai-analysis">
                    <div class="result-title">AI Investment strategy</div>
                    <div class="result-content">${aiAnalysis.raw_response}</div>
                </div>`;
            }
            aiContent.innerHTML = html;
        }
        function displayPrincipalPlan(principalPlan) {
            const principalContent = document.getElementById('principalContent');
            if (!principalPlan) {
                principalContent.innerHTML = `<div class="result-item">
                    <div class="result-title">Principal Plan</div>
                    <div class="result-content">Principal plan was not requested.</div>
                </div>`;
                return;
            }

            if (!principalPlan.success) {
                const errorMessage = principalPlan.error || 'Principal agent failed to generate a plan.';
                principalContent.innerHTML = `<div class="result-item error">
                    <div class="result-title">Principal Plan Failed</div>
                    <div class="result-content">${errorMessage}</div>
                </div>`;
                return;
            }

            const plan = principalPlan.data;
            if (!plan) {
                principalContent.innerHTML = `<div class="result-item">
                    <div class="result-title">Principal Plan</div>
                    <div class="result-content">Plan data unavailable.</div>
                </div>`;
                return;
            }

            const strategies = plan.strategies || {};
            const strategyOrder = [
                { key: 'day_trading', label: 'Day Trading' },
                { key: 'swing_trading', label: 'Swing Trading' },
                { key: 'longterm_trading', label: 'Long-Term Trading' },
            ];

            let strategyHtml = '';
            strategyOrder.forEach(({ key, label }) => {
                const strategy = strategies[key];
                if (!strategy) {
                    return;
                }

                const summary = strategy.summary || 'No summary provided.';
                const keyLevels = strategy.key_levels;
                const nextActions = strategy.next_actions;

                strategyHtml += `<div class="ai-section">
                    <div class="ai-section-title">${label}</div>
                    <div class="result-content">
                        <p><strong>Summary:</strong> ${summary}</p>
                        ${keyLevels ? formatKeyLevels(keyLevels) : ''}
                        ${nextActions ? formatNextActions(nextActions) : ''}
                    </div>
                </div>`;
            });

            const usage = plan.usage;
            const usageHtml = usage ? `<div class="plan-meta">Tokens used: ${usage.total_tokens ?? 'N/A'}</div>` : '';

            const generatedAt = plan.generated_at ? new Date(plan.generated_at).toLocaleString() : 'N/A';

            const rawSection = plan.trading_agent_outputs
                ? `<details class="plan-raw">
                        <summary>Expert Diagnostics</summary>
                        <pre>${escapeHtml(JSON.stringify(plan.trading_agent_outputs, null, 2))}</pre>
                   </details>`
                : '';

            principalContent.innerHTML = `
                <div class="result-item success ai-analysis">
                    <div class="result-title">Principal Trading Plan</div>
                    <div class="result-content">
                        <p><strong>Symbol:</strong> ${plan.symbol || 'N/A'}</p>
                        <p><strong>Generated:</strong> ${generatedAt}</p>
                        ${usageHtml}
                    </div>
                </div>
                ${strategyHtml || '<div class="result-item"><div class="result-content">No strategy breakdown available.</div></div>'}
                ${rawSection}
            `;
        }

        function formatKeyLevels(keyLevels) {
            if (!keyLevels) return '';
            if (Array.isArray(keyLevels)) {
                if (keyLevels.length === 0) return '';
                return `<p><strong>Key Levels:</strong></p>
                        <ul>${keyLevels.map(level => `<li>${escapeHtml(level)}</li>`).join('')}</ul>`;
            }
            if (typeof keyLevels === 'object') {
                const entries = Object.entries(keyLevels);
                if (!entries.length) return '';
                return `<p><strong>Key Levels:</strong></p>
                        <ul>${entries.map(([name, value]) => `<li>${escapeHtml(name)}: ${escapeHtml(value)}</li>`).join('')}</ul>`;
            }
            return `<p><strong>Key Levels:</strong> ${escapeHtml(keyLevels)}</p>`;
        }

        function formatNextActions(nextActions) {
            if (!nextActions) return '';
            if (Array.isArray(nextActions)) {
                if (!nextActions.length) return '';
                return `<p><strong>Next Actions:</strong></p>
                        <ul>${nextActions.map(action => `<li>${escapeHtml(action)}</li>`).join('')}</ul>`;
            }
            if (typeof nextActions === 'object') {
                const entries = Object.entries(nextActions);
                if (!entries.length) return '';
                return `<p><strong>Next Actions:</strong></p>
                        <ul>${entries.map(([name, value]) => `<li>${escapeHtml(name)}: ${escapeHtml(value)}</li>`).join('')}</ul>`;
            }
            return `<p><strong>Next Actions:</strong> ${escapeHtml(nextActions)}</p>`;
        }

    function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
        }
        function displayError(error) {
            const technicalContent = document.getElementById('technicalContent');
            technicalContent.innerHTML = `
                <div class="result-item error">
                    <div class="result-title">Analysis Failed</div>
                    <div class="result-content">${error}</div>
                </div>
            `;
        }
        function showTab(tabName, evt) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}Content`).classList.add('active');
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            }
        }
        // To hide by default, add class="tabs hidden" in HTML and define .hidden in your CSS:
        // .hidden { display: none !important;}
    </script>
</body>
</html>
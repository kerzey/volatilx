<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Volatilx</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f8fa; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #ddd; margin-bottom: 20px; padding: 16px; }
        .analysis-list { list-style: none; padding: 0; }
        .analysis-list li { padding: 6px 0; border-bottom: 1px solid #efefef; }
        .decision { font-weight: bold; padding-left: 10px; color: #2362cd; }
        .error { color: red; }
        table tbody tr:hover { background-color: #f0f8ff; }
    </style>
    <script>
        function renderResult(data) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';
    if (!data.success) {
        resultDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        return;
    }
    const result = data.result;
    for (let symbol in result) {
        const stock = result[symbol];
        let sections = [];
        let block = {}; // Track current block of parsed details

        stock.analysis.forEach(line => {
            // Skip separators or empty lines
            if (line.startsWith('=') || line.trim() === '' || line.startsWith('---')) return;

            // Timeframe info (e.g., "90m: Bias: ...")
            if (line.match(/^\s*\d+[mh]:/)) {
                const match = line.match(/(\d+[mh]): Bias: ([^,]+), Confidence: ([^,\s]+)/);
                if (match) {
                    block.timeframe = match[1];
                    block.bias = match[2];
                    block.confidence = match[3];
                } else {
                    block.timeframe = block.bias = block.confidence = 'N/A';
                }
                return;
            }

            // Price, support, resistance
            if (line.match(/Price:/)) {
                const match = line.match(/Price: ([^,]+), Support: ([^,]+), Resistance: ([^,]+)/);
                if (match) {
                    block.price = match[1];
                    block.support = match[2];
                    block.resistance = match[3];
                } else {
                    block.price = block.support = block.resistance = 'N/A';
                }
                return;
            }

            // Decision
            if (line.match(/Decision:/)) {
                block.decision = line.split('Decision: ')[1];
                // If any key is missing, default to 'N/A'
                const sec = {
                    timeframe: block.timeframe || 'N/A',
                    bias: block.bias || 'N/A',
                    confidence: block.confidence || 'N/A',
                    price: block.price || 'N/A',
                    support: block.support || 'N/A',
                    resistance: block.resistance || 'N/A',
                    decision: block.decision || 'N/A'
                };
                sections.push(sec);
                // Reset block for next
                block = {};
            }
        });

        let tableHtml = `
            <table style="width:100%;margin-top:10px;border-collapse:collapse;">
                <thead><tr>
                    <th>Timeframe</th>
                    <th>Bias</th>
                    <th>Confidence</th>
                    <th>Price</th>
                    <th>Support</th>
                    <th>Resistance</th>
                    <th>Action</th>
                </tr></thead>
                <tbody>
        `;

        sections.forEach(sec => {
            let color = "black";
            if (sec.decision.startsWith('BUY')) color = "green";
            else if (sec.decision.startsWith('SELL')) color = "red";
            else if (sec.decision.startsWith('HOLD')) color = "orange";
            tableHtml += `
                <tr>
                    <td>${sec.timeframe}</td>
                    <td>${sec.bias}</td>
                    <td>${sec.confidence}</td>
                    <td>${isNaN(sec.price) ? sec.price : Number(sec.price).toFixed(2)}</td>
                    <td>${isNaN(sec.support) ? sec.support : Number(sec.support).toFixed(2)}</td>
                    <td>${isNaN(sec.resistance) ? sec.resistance : Number(sec.resistance).toFixed(2)}</td>
                    <td style="font-weight:bold;color:${color}">${sec.decision}</td>
                </tr>
            `;
        });
        tableHtml += '</tbody></table>';

        resultDiv.innerHTML += `
            <div class="card">
                <h2>${symbol}: ${stock.status}</h2>
                ${sections.length ? tableHtml : "<em>No actionable analysis found.</em>"}
                ${stock.error ? `<div class="error">${stock.error}</div>` : ''}
            </div>
        `;
    }
}
        async function tradeStock() {
            const stockSymbol = document.getElementById('stockSymbol').value;
            const response = await fetch('/trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock_symbol: stockSymbol })
            });
            const data = await response.json();
            renderResult(data);
        }

        async function fetchIndicators() {
            const stockSymbol = document.getElementById('stockSymbol').value;
            const response = await fetch('/indicators', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock_symbol: stockSymbol })
            });
            const data = await response.json();
            renderResult(data);
        }
        async function tradeStock() {
    const stockSymbol = document.getElementById('stockSymbol').value.trim();
    if (!stockSymbol) {
        alert('Please enter a valid stock symbol.');
        return;
    }
    try {
        const response = await fetch('/trade', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock_symbol: stockSymbol })
        });
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        const data = await response.json();
        renderResult(data);
    } catch (error) {
        console.error('Error fetching trade data:', error);
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `<div class="error">Failed to fetch trade data. Please try again later.</div>`;
    }
}
    </script>
</head>
<body>
    <h1>Volatilx</h1>
    <input type="text" id="stockSymbol" placeholder="Enter Stock Symbol">
    <button onclick="tradeStock()">Trade</button>
    <button onclick="fetchIndicators()">Fetch Indicators</button>
    <div id="result"></div>
</body>
</html>
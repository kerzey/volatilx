<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolatilX - Settings</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BC00YPJSRJ"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BC00YPJSRJ');
    </script>
</head>
<body class="settings-page">
    <div class="header">
        <a class="logo" href="/trade">
            <img src="/static/VolatilX_Logo.PNG" alt="VolatilX Logo">
            <span>VolatilX</span>
        </a>
        <div class="nav-links">
            <a href="/trade">Trading</a>
            <a href="/dashboard">Dashboard</a>
            <a href="/subscribe">Plans</a>
            <a href="/settings" class="active">Settings</a>
            <span>{{ user.email }}</span>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="settings-panel">
            <h1 class="panel-title">Account Settings</h1>

            <section class="section">
                <h2 class="section-title">Account Information</h2>
                <p class="section-description">Your account details and status</p>
                <div class="user-info">
                    <p><strong>Email:</strong> {{ user.email }}</p>
                    <p><strong>Account Status:</strong> <span class="status-indicator status-active"></span>Active</p>
                    <p><strong>Member Since:</strong> {{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'N/A' }}</p>
                </div>
            </section>

            <section class="section" id="subscriptionSection">
                <h2 class="section-title">Subscription Plans</h2>
                <p class="section-description">Choose a plan to unlock monthly AI agent strategy runs. Upgrade anytime.</p>

                <div class="subscription-status" id="subscriptionStatus">
                    <strong>Current Plan</strong>
                    <div id="subscriptionStatusValue">Loading subscription detailsâ€¦</div>
                </div>

                <div class="subscription-message" id="subscriptionMessage" role="alert" aria-live="polite"></div>

                <div class="plan-grid" id="planGrid">
                    <div class="plan-grid-empty">Loading plansâ€¦</div>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">AI Analysis</h2>
                <p class="section-description">AI-powered investment analysis status</p>

                <div class="info-box">
                    <h4>âœ… AI Analysis Available</h4>
                    <p>AI-powered investment analysis is enabled for all users.</p>
                    <p>Get detailed market insights, risk assessments, and trading recommendations powered by advanced AI.</p>
                    <p><strong>Features included:</strong></p>
                    <ul class="info-list">
                        <li>Market position assessment</li>
                        <li>Short-term and long-term strategies</li>
                        <li>Risk analysis and mitigation</li>
                        <li>Actionable trading recommendations</li>
                    </ul>
                </div>

                <div class="status-row">
                    <span class="status-indicator status-active"></span>
                    <strong>AI Analysis: Ready to use</strong>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">Trading Preferences</h2>
                <p class="section-description">Customize your trading analysis settings</p>
                <div class="info-box">
                    <h4>ðŸ“Š Current Settings</h4>
                    <p><strong>Buy Threshold:</strong> 70% confidence</p>
                    <p><strong>Sell Threshold:</strong> 70% confidence</p>
                    <p><strong>Analysis Mode:</strong> High confidence only</p>
                    <p><strong>Timeframes:</strong> 1m, 5m, 15m, 30m, 1h, 1d, 1wk</p>
                </div>
            </section>

            <section class="section">
                <h2 class="section-title">Security</h2>
                <p class="section-description">Account security and authentication</p>
                <div class="user-info">
                    <p><strong>Authentication Method:</strong>
                        {% if user.oauth_provider %}
                            {{ user.oauth_provider.title() }} OAuth
                        {% else %}
                            Email & Password
                        {% endif %}
                    </p>
                    <p><strong>Account Verified:</strong>
                        {% if user.is_verified %}
                            <span class="verified">âœ“ Verified</span>
                        {% else %}
                            <span class="not-verified">âœ— Not Verified</span>
                        {% endif %}
                    </p>
                </div>
            </section>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const planGrid = document.getElementById('planGrid');
    const statusValue = document.getElementById('subscriptionStatusValue');
    const messageBox = document.getElementById('subscriptionMessage');
    const subscriptionSection = document.getElementById('subscriptionSection');
    const priceFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

    const PLAN_META = {
        alpha: {
            themeClass: 'plan-card--alpha',
            logo: '/static/Alpha.PNG',
            tagline: 'Silver-tier intelligence for confident entries.',
            features: [
                'Multi-timeframe AI technical breakdowns',
                'Access to principal agent trade plans',
                'Email support during market hours',
            ],
            badge: 'Starter',
            ctaLabel: 'Activate Alpha',
        },
        sigma: {
            themeClass: 'plan-card--sigma',
            logo: '/static/Sigma.PNG',
            tagline: 'Gold coverage for active swing & day traders.',
            features: [
                'Expanded monthly AI run allowance',
                'Priority queueing around market opens',
                'Advanced price-action scenario modeling',
            ],
            badge: 'Most Popular',
            ctaLabel: 'Upgrade to Sigma',
        },
        omega: {
            themeClass: 'plan-card--omega',
            logo: '/static/Omega.PNG',
            tagline: 'Black titanium access for elite strategy teams.',
            features: [
                'Maximum monthly AI collaborations included',
                'Early access to experimental VolatilX agents',
                'Concierge research and quarterly briefings',
            ],
            badge: 'Elite',
            ctaLabel: 'Go Omega',
            note: 'Includes executive briefings and roadmap previews.',
        },
    };

    function setMessage(text, tone = 'error') {
        const toneColors = {
            error: '#c0392b',
            success: '#2e7d32',
            info: '#2c3e50',
        };
        messageBox.textContent = text || '';
        messageBox.style.color = toneColors[tone] || toneColors.error;
    }

    function escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatPrice(cents) {
        return priceFormatter.format((cents || 0) / 100);
    }

    function formatStatus(status) {
        if (!status) {
            return 'unknown';
        }
        return status.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function formatDate(value) {
        if (!value) {
            return 'N/A';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return 'N/A';
        }
        return date.toLocaleString();
    }

    function renderSubscriptionStatus(subscription) {
        if (!subscription || !subscription.plan) {
            statusValue.textContent = 'No active subscription. Select a plan below to enable AI agent runs.';
            return;
        }

        const parts = [
            `${subscription.plan.name} Â· ${formatStatus(subscription.status)}`,
            `Runs left: ${subscription.runs_remaining ?? 'N/A'}`,
            `Renews: ${formatDate(subscription.current_period_end)}`,
        ];
        statusValue.textContent = parts.join(' | ');
    }

    function createPlanCard(plan, isCurrent) {
        const card = document.createElement('div');
        card.className = 'plan-card';

        const slug = (plan.slug || '').toLowerCase();
        const meta = PLAN_META[slug] || {};

        if (meta.themeClass) {
            card.classList.add(meta.themeClass);
        }
        if (isCurrent) {
            card.classList.add('plan-card--current');
        }

        const planName = escapeHtml(plan.name || 'VolatilX Plan');
        const badgeLabel = isCurrent ? 'Current plan' : meta.badge;
        const badgeMarkup = badgeLabel ? `<span class="plan-card__badge">${escapeHtml(badgeLabel)}</span>` : '';
        const taglineMarkup = meta.tagline ? `<p class="plan-card__tagline">${escapeHtml(meta.tagline)}</p>` : '';
        const descriptionSource = plan.description || meta.description || '';
        const descriptionMarkup = descriptionSource
            ? `<p class="plan-card__description">${escapeHtml(descriptionSource).replace(/\n/g, '<br>')}</p>`
            : '';
        const featuresHtml = (meta.features || [])
            .map((feature) => `<li>${escapeHtml(feature)}</li>`)
            .join('');
        const noteMarkup = meta.note ? `<div class="plan-card__note">${escapeHtml(meta.note)}</div>` : '';
        const runsLabel = `${escapeHtml(String(plan.ai_runs_included ?? '0'))} AI agent runs monthly`;

        card.innerHTML = `
            <div class="plan-card__header">
                ${meta.logo ? `<div class="plan-card__logo"><img src="${meta.logo}" alt="${planName} logo"></div>` : ''}
                <div class="plan-card__title">
                    <span class="plan-card__name">${planName}</span>
                    ${taglineMarkup}
                </div>
                ${badgeMarkup}
            </div>
            <div class="plan-card__price">${formatPrice(plan.monthly_price_cents)} <span>/ month</span></div>
            <div class="plan-card__runs">${runsLabel}</div>
            ${descriptionMarkup}
            ${featuresHtml ? `<ul class="plan-card__features">${featuresHtml}</ul>` : ''}
            ${noteMarkup}
        `;

        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'plan-button';

        if (!plan.stripe_price_configured) {
            button.textContent = 'Unavailable';
            button.disabled = true;
        } else if (isCurrent) {
            button.textContent = 'Current Plan';
            button.disabled = true;
        } else {
            button.textContent = meta.ctaLabel || 'Select Plan';
            button.addEventListener('click', () => startCheckout(plan.slug, button));
        }

        card.appendChild(button);
        return card;
    }

    function renderPlans(plans, subscription) {
        planGrid.innerHTML = '';
        if (!plans || plans.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'plan-grid-empty';
            empty.textContent = 'No plans are available right now. Please check back later.';
            planGrid.appendChild(empty);
            return;
        }

        const currentSlug = subscription && subscription.plan ? subscription.plan.slug : null;
        const order = ['alpha', 'sigma', 'omega'];
        const sortedPlans = [...plans].sort((a, b) => {
            const aSlug = (a.slug || '').toLowerCase();
            const bSlug = (b.slug || '').toLowerCase();
            const aIndex = order.indexOf(aSlug);
            const bIndex = order.indexOf(bSlug);
            const safeA = aIndex === -1 ? order.length : aIndex;
            const safeB = bIndex === -1 ? order.length : bIndex;
            if (safeA === safeB) {
                return (a.monthly_price_cents || 0) - (b.monthly_price_cents || 0);
            }
            return safeA - safeB;
        });

        sortedPlans.forEach((plan) => {
            const isCurrent = currentSlug === plan.slug;
            const card = createPlanCard(plan, isCurrent);
            planGrid.appendChild(card);
        });
    }

    async function startCheckout(planSlug, trigger) {
        if (!planSlug) {
            return;
        }

        const originalText = trigger.textContent;
        trigger.disabled = true;
        trigger.textContent = 'Redirectingâ€¦';
        setMessage('');

        try {
            const response = await fetch('/api/billing/checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ plan_slug: planSlug }),
            });

            if (!response.ok) {
                const errorPayload = await response.json().catch(() => ({}));
                const detail = errorPayload.detail || 'Unable to start checkout. Please try again.';
                throw new Error(detail);
            }

            const data = await response.json();
            if (data.checkout_url) {
                window.location.href = data.checkout_url;
                return;
            }

            throw new Error('Checkout session did not return a redirect URL.');
        } catch (error) {
            setMessage(error.message || 'Billing error. Please try again later.');
        } finally {
            trigger.disabled = false;
            trigger.textContent = originalText;
        }
    }

    function focusBillingTabIfNeeded(subscription) {
        const params = new URLSearchParams(window.location.search);
        const selectedTab = params.get('tab');
        if (!selectedTab || selectedTab.toLowerCase() !== 'billing' || !subscriptionSection) {
            return;
        }

        setTimeout(() => {
            subscriptionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 150);

        subscriptionSection.classList.add('section--spotlight');
        setTimeout(() => subscriptionSection.classList.remove('section--spotlight'), 1800);

        if (!subscription || !subscription.plan) {
            setMessage('Choose a plan to unlock premium AI strategies.', 'info');
        }
    }

    async function loadBilling() {
        try {
            const response = await fetch('/api/billing/plans');
            if (!response.ok) {
                throw new Error('Failed to load subscription plans.');
            }

            const data = await response.json();
            renderSubscriptionStatus(data.current_subscription);
            renderPlans(data.plans, data.current_subscription);
            setMessage('');
            focusBillingTabIfNeeded(data.current_subscription);
        } catch (error) {
            setMessage(error.message || 'Unexpected error loading billing information.');
            planGrid.innerHTML = '';
            const empty = document.createElement('div');
            empty.className = 'plan-grid-empty';
            empty.textContent = 'Unable to load plans at this time.';
            planGrid.appendChild(empty);
            statusValue.textContent = 'Billing information is currently unavailable.';
            focusBillingTabIfNeeded(null);
        }
    }

    loadBilling();
    });
    </script>
    {% include "_contact_widget.html" %}
</body>
</html>